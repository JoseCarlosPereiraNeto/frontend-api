<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cadastrar Pedido</title>
    <link rel="stylesheet" href="css/cadastro_pedido_style.css" />
</head>
<body>
    <header class="banner">
        <div class="logo-container">
            <img src="https://www.argenzio.com.br/img/Logo_Argenzio.png" alt="Logo Argenzio" />
        </div>
    </header>

    <nav class="menu">
        <ul>
            <li><a href="./index_ven.html">HOME</a></li>
            <li><a href="./conta.html">CONTA</a></li>
        </ul>
    </nav>

    <main class="cadastro-pedidos">
        <div class="layout">
            <div class="areaDeCadastro">
                <h1>Cadastrar Pedido</h1>
                <form onsubmit="event.preventDefault(); criarPedido();" class="formulario-pedido">
                    <div class="containerTabela">
                        <h2>Tabela de Clientes</h2>
                        <input
                            type="text"
                            id="pesquisarCliente"
                            onkeyup="pesquisarClientes()"
                            placeholder="Pesquisar por nome..."
                        />
                        <div class="tabela-rolavel">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>CNPJ</th>
                                        <th>CEP</th>
                                        <th>Telefone</th>
                                        <th>Adicionar Cliente</th>
                                    </tr>
                                </thead>
                                <tbody id="corpoTabelaClientes"></tbody>
                            </table>
                        </div>
                    </div>

                    <label for="dataPedido">Data</label>
                    <input type="date" id="dataPedido" name="dataPedido" required />
                    <button type="submit">Cadastrar pedido</button>
                </form>
            </div>

            <div class="containerTabela">
                <h2>Tabela de Produtos</h2>
                <input
                    type="text"
                    id="pesquisarProduto"
                    onkeyup="pesquisarProdutos()"
                    placeholder="Pesquisar por nome..."
                />
                <div class="tabela-rolavel">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Pre√ßo</th>
                                <th>Adicionar Ao Carrinho</th>
                            </tr>
                        </thead>
                        <tbody id="corpoTabelaProdutos"></tbody>
                    </table>
                </div>

                <div class="carrinho-produtos">
                    <h2>Carrinho de Produtos</h2>
                    <ul id="listaCarrinho"></ul>
                    <p>Total: <span id="totalCarrinho">R$ 0,00</span></p>
                </div>
            </div>
        </div>
    </main>

    <script>
        let carrinho = [];
        let clienteSelecionado = null;

        function adicionarAoCarrinho(idProduto, nome, preco) {
            const itemNoCarrinho = carrinho.find((item) => item.idProduto === idProduto);
            if (itemNoCarrinho) {
                itemNoCarrinho.quantidade++;
            } else {
                carrinho.push({ idProduto, nome, preco, quantidade: 1 });
            }
            atualizarCarrinho();
        }

        function atualizarCarrinho() {
            const listaCarrinho = document.getElementById("listaCarrinho");
            const totalCarrinho = document.getElementById("totalCarrinho");
            listaCarrinho.innerHTML = "";
            let total = 0;

            carrinho.forEach((item, index) => {
                const listItem = document.createElement("li");
                listItem.textContent = `${item.nome}, ${item.quantidade} unidade${
                    item.quantidade > 1 ? "s" : ""
                }, ${item.preco.toLocaleString("pt-BR", {
                    style: "currency",
                    currency: "BRL",
                })}`;

                const botaoRemover = document.createElement("button");
                botaoRemover.textContent = "Remover";
                botaoRemover.onclick = () => removerDoCarrinho(index);
                listItem.appendChild(botaoRemover);

                listaCarrinho.appendChild(listItem);
                total += item.preco * item.quantidade;
            });

            totalCarrinho.textContent = total.toLocaleString("pt-BR", {
                style: "currency",
                currency: "BRL",
            });
        }

        function removerDoCarrinho(index) {
            carrinho.splice(index, 1);
            atualizarCarrinho();
        }

        function pesquisarProdutos() {
            const filtro = document.getElementById("pesquisarProduto").value.toUpperCase();
            const linhas = document
                .getElementById("corpoTabelaProdutos")
                .getElementsByTagName("tr");

            for (let i = 0; i < linhas.length; i++) {
                const nomeProduto = linhas[i].getElementsByTagName("td")[0];
                if (nomeProduto) {
                    const texto = nomeProduto.textContent || nomeProduto.innerText;
                    linhas[i].style.display = texto.toUpperCase().indexOf(filtro) > -1 ? "" : "none";
                }
            }
        }

        function pesquisarClientes() {
            const filtro = document.getElementById("pesquisarCliente").value.toUpperCase();
            const linhas = document
                .getElementById("corpoTabelaClientes")
                .getElementsByTagName("tr");

            for (let i = 0; i < linhas.length; i++) {
                const nomeCliente = linhas[i].getElementsByTagName("td")[0];
                if (nomeCliente) {
                    const texto = nomeCliente.textContent || nomeCliente.innerText;
                    linhas[i].style.display = texto.toUpperCase().indexOf(filtro) > -1 ? "" : "none";
                }
            }
        }

        function selecionarCliente(idCliente, event) {
            clienteSelecionado = idCliente;
            const nome = event.target.parentNode.parentNode.querySelector('td').textContent;
            alert(`Cliente selecionado: ${nome}`);
        }

        async function carregarProdutos() {
            try {
                let token = localStorage.getItem("token");
                const response = await fetch("http://localhost:4040/produtos", {
                    headers: { authorization: "bearer " + token },
                });
                const data = await response.json();

                if (data.success) {
                    const corpoTabela = document.getElementById("corpoTabelaProdutos");
                    corpoTabela.innerHTML = "";

                    data.values.forEach((produto) => {
                        const linha = document.createElement("tr");

                        const tdNome = document.createElement("td");
                        tdNome.textContent = produto.descricao;

                        const tdPreco = document.createElement("td");
                        const preco = parseFloat(produto.valorUnitario);
                        tdPreco.textContent = preco.toLocaleString("pt-BR", {
                            style: "currency",
                            currency: "BRL",
                        });

                        const tdAcao = document.createElement("td");
                        const botao = document.createElement("button");
                        botao.textContent = "Adicionar";
                        botao.title = `Adicionar ${produto.descricao} ao carrinho`;
                        botao.onclick = () => adicionarAoCarrinho(produto.idProduto, produto.descricao, preco);
                        tdAcao.appendChild(botao);

                        linha.appendChild(tdNome);
                        linha.appendChild(tdPreco);
                        linha.appendChild(tdAcao);
                        corpoTabela.appendChild(linha);
                    });
                } else {
                    console.error("Erro ao buscar produtos:", data.message);
                }
            } catch (error) {
                console.error("Erro de rede ao buscar produtos:", error);
            }
        }

        async function carregarClientes() {
            try {
                let token = localStorage.getItem("token");
                const response = await fetch("http://localhost:4040/clientes", {
                    headers: { authorization: "bearer " + token },
                });
                const data = await response.json();

                if (data.success) {
                    const corpoTabela = document.getElementById("corpoTabelaClientes");
                    corpoTabela.innerHTML = "";

                    data.values.forEach((cliente) => {
                        const linha = document.createElement("tr");

                        const tdNome = document.createElement("td");
                        tdNome.textContent = cliente.nome;

                        const tdCNPJ = document.createElement("td");
                        tdCNPJ.textContent = cliente.CNPJ;

                        const tdCEP = document.createElement("td");
                        tdCEP.textContent = cliente.CEP;

                        const tdTelefone = document.createElement("td");
                        tdTelefone.textContent = cliente.telefone;

                        const tdAcao = document.createElement("td");
                        const botao = document.createElement("button");
                        botao.textContent = "Selecionar";
                        botao.onclick = (event) => selecionarCliente(cliente.idCliente, event);
                        // Removido o segundo botao.onclick que sobrescrevia o primeiro
                        tdAcao.appendChild(botao);

                        linha.appendChild(tdNome);
                        linha.appendChild(tdCNPJ);
                        linha.appendChild(tdCEP);
                        linha.appendChild(tdTelefone);
                        linha.appendChild(tdAcao);
                        corpoTabela.appendChild(linha);
                    });
                } else {
                    console.error("Erro ao buscar clientes:", data.message);
                }
            } catch (error) {
                console.error("Erro de rede ao buscar clientes:", error);
            }
        }

        async function criarPedido() {
            if (!clienteSelecionado) {
                alert("Selecione um cliente antes de criar o pedido.");
                return;
            }

            if (carrinho.length === 0) {
                alert("Adicione pelo menos um produto ao carrinho.");
                return;
            }

            const dataSelecionada = document.getElementById("dataPedido").value;
            if (!dataSelecionada) {
                alert("Por favor, selecione uma data.");
                return;
            }

            let token = localStorage.getItem("token");

            const pedido = {
                idCliente: clienteSelecionado,
                dataPedido: dataSelecionada,
                items: carrinho.map(({ idProduto, quantidade }) => ({
                    idProduto,
                    quantidade,
                })),
            };

            try {
                const response = await fetch("http://localhost:4040/pedidos", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: "Bearer " + token,
                    },
                    body: JSON.stringify(pedido),
                });
                const data = await response.json();

                if (data.success) {
                    alert("Pedido criado com sucesso!");
                    clienteSelecionado = null;
                    carrinho = [];
                    atualizarCarrinho();
                    carregarClientes();
                    carregarProdutos();
                    document.getElementById("dataPedido").value = "";
                } else {
                    alert("Erro ao criar pedido: " + data.message);
                }
            } catch (error) {
                alert("Erro ao criar pedido: " + error.message);
            }
        }

        carregarProdutos();
        carregarClientes();
    </script>
</body>
</html>





