<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastrar Pedido</title>
    <link rel="stylesheet" href="css/cadastro_pedido_style.css">
    <style>
        /* Estilos adicionais (se necessário) */
    </style>
    <script>
let carrinho = [];

function adicionarAoCarrinho(idProduto, nome, preco) {
    const itemNoCarrinho = carrinho.find(item => item.idProduto === idProduto);

    if (itemNoCarrinho) {
        itemNoCarrinho.quantidade++;
    } else {
        carrinho.push({ idProduto: idProduto, nome: nome, preco: preco, quantidade: 1 });
    }

    atualizarCarrinho();
}

function atualizarCarrinho() {
    const listaCarrinho = document.getElementById('listaCarrinho');
    const totalCarrinho = document.getElementById('totalCarrinho');

    listaCarrinho.innerHTML = '';

    let total = 0;

    carrinho.forEach((item, index) => {
        const listItem = document.createElement('li');
        listItem.textContent = `${item.nome}, ${item.quantidade} unidade${item.quantidade > 1 ? 's' : ''}, R$${(item.preco).toFixed(2).replace('.', ',')}`;

        const botaoRemover = document.createElement('button');
        botaoRemover.textContent = 'Remover';
        botaoRemover.onclick = () => removerDoCarrinho(index);
        listItem.appendChild(botaoRemover);

        listaCarrinho.appendChild(listItem);
        total += item.preco * item.quantidade;
    });

    totalCarrinho.textContent = total.toFixed(2).replace('.', ',');
}

function removerDoCarrinho(index) {
    carrinho.splice(index, 1);
    atualizarCarrinho();
}

function pesquisarProdutos() {
    const input = document.getElementById("pesquisarProduto");
    const filtro = input.value.toUpperCase();
    const tabela = document.querySelector(".tabela-rolavel table");
    const linhas = tabela.getElementsByTagName("tr");

    for (let i = 1; i < linhas.length; i++) {
        const colunaNome = linhas[i].getElementsByTagName("td")[0];
        if (colunaNome) {
            const textoNome = colunaNome.textContent || colunaNome.innerText;
            linhas[i].style.display = textoNome.toUpperCase().indexOf(filtro) > -1 ? "" : "none";
        }
    }
}

window.onload = async function () {
    try {
        const response = await fetch('http://localhost:4040/produtos');
        const data = await response.json();

        if (data.success && Array.isArray(data.values)) {
            const corpoTabela = document.getElementById('corpoTabelaProdutos');
            corpoTabela.innerHTML = '';

            data.values.forEach(produto => {
                const linha = document.createElement('tr');

                const colunaNome = document.createElement('td');
                colunaNome.textContent = produto.descricao;

                const colunaPreco = document.createElement('td');
                const preco = parseFloat(produto.valorUnitario);
                colunaPreco.textContent = `R$${preco.toFixed(2).replace('.', ',')}`;

                const colunaAcao = document.createElement('td');
                const botao = document.createElement('button');
                botao.textContent = 'Adicionar';
                botao.onclick = () => adicionarAoCarrinho(produto.idProduto, produto.descricao, preco);

                colunaAcao.appendChild(botao);

                linha.appendChild(colunaNome);
                linha.appendChild(colunaPreco);
                linha.appendChild(colunaAcao);

                corpoTabela.appendChild(linha);
            });
        } else {
            console.error('Erro ao buscar produtos:', data.message);
        }
    } catch (error) {
        console.error('Erro de rede ao buscar produtos:', error);
    }
};

async function criarPedido() {
    const pedido = {
        status: 'Pendente',
        data: new Date().toISOString(),
        idUsuario: 1,
        idCliente: 123, // Substitua por um ID real
        itens: carrinho.map(item => ({
            idProduto: item.idProduto,
            quantidade: item.quantidade,
            valorCombinado: item.preco * item.quantidade
        }))
    };

    try {
        const response = await fetch('http://localhost:4040/pedidos', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(pedido)
        });

        const data = await response.json();

        if (data.success) {
            alert('Pedido criado com sucesso! ID do Pedido: ' + data.idPedido);
        } else {
            console.error('Erro na resposta do servidor:', data);
            alert('Erro ao criar o pedido:\n' + JSON.stringify(data, null, 2));
        }
    } catch (error) {
        console.error('Erro de rede:', error);
        alert('Erro de rede: ' + error.message);
    }
}

    </script>
</head>
<body>
    <header class="banner">
        <div class="logo-container">
            <img src="https://www.argenzio.com.br/img/Logo_Argenzio.png" alt="Logo Argenzio">
        </div>
    </header>

    <nav class="menu">
        <ul>
            <li><a href="./index_ven.html">HOME</a></li>
            <li><a href="./conta.html">CONTA</a></li>
            <li><a href="./ajuda.html">AJUDA</a></li>
            <li><a href="#">CONTATO</a></li>
        </ul>
    </nav>

    <main class="cadastro-pedidos">
        <div class="layout">
            <div class="areaDeCadastro">
                <h1>Cadastrar Pedido</h1>
                <form onsubmit="event.preventDefault(); criarPedido();" class="formulario-pedido">
                    <label for="nomeCliente">Nome do Cliente:</label>
                    <input type="text" id="nomeCliente" name="nomeCliente" required>

                    <label for="clienteCEP">CEP</label>
                    <input type="number" id="clienteCEP" name="clienteCEP" required>

                    <label for="clienteCNPJ">CNPJ</label>
                    <input type="number" id="clienteCNPJ" name="clienteCNPJ" required>

                    <label for="clienteContato">Forma de Contato</label>
                    <input type="tel" id="clienteTelefone" name="clienteTelefone" placeholder="telefone" required>
                    <input type="email" id="clienteEmail" name="clienteEmail" placeholder="email" required>

                    <label for="dataPedido">Data</label>
                    <input type="date" id="dataPedido" name="dataPedido" required>
                    <button type="submit">Cadastrar pedido</button>
                </form>
            </div>

            <div class="containerTabela">
                <h2>Tabela de Produtos</h2>
                <input type="text" id="pesquisarProduto" onkeyup="pesquisarProdutos()" placeholder="Pesquisar por nome...">
                <div class="tabela-rolavel">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Preço</th>
                                <th>Adicionar Ao Carrinho</th>
                            </tr>
                        </thead>
                        <tbody id="corpoTabelaProdutos">
                            <!-- Produtos serão inseridos aqui -->
                        </tbody>
                    </table>
                </div>
                <div class="carrinho-produtos">
                    <h2>Carrinho de Produtos</h2>
                    <ul id="listaCarrinho"></ul>
                    <p>Total: R$ <span id="totalCarrinho">0,00</span></p>
                </div>
            </div>
        </div>
    </main>
</body>
</html>

